const volume_slider = document.querySelector(".volume-slider");
const canvas = document.querySelector("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const state = Object.freeze({
    Menu: 0,
    Playing: 1,
    Paused: 2,
});

const GRACE_PERIOD = 0.1;
const SPEED_HACK = 1.0;
const SPEED_MULTIPLIER = 1.0;
const START_OFFSET = 0;

class Note {
    constructor(offset) {
        this.countdown = offset / SPEED_HACK;
        this.is_clickable = false;
    }
    update(delta_time) {
        this.countdown -= SPEED_MULTIPLIER * delta_time;
        this.is_clickable = Math.abs(this.countdown) <= GRACE_PERIOD;
    }
}

function get_y_coord(y) {
	return canvas.height * (1 - (y - MIN_NOTE_DISPLAY) / (MAX_NOTE_DISPLAY - MIN_NOTE_DISPLAY));
}

const INTRO_TIME = 1.0;
const SONG_INTRO_TIME = 0.3;
const MIN_NOTE_DISPLAY = -0.3;
const MAX_NOTE_DISPLAY = 1.5;
const TILE_HEIGHT = (get_y_coord(GRACE_PERIOD) - get_y_coord(0.0)) * SPEED_MULTIPLIER;
const LANE_WIDTH = 50;
const LANE_PADDING = 10;
const LANE_LEFT = (canvas.width - LANE_WIDTH * 5 - LANE_PADDING * 4) / 2;
const lanes = [[], [], [], [], []];
let game_running = true;
let combo = 0;

let keyboard = {
	"d": [false, false, false],
	"f": [false, false, false],
	"j": [false, false, false],
	"k": [false, false, false],
	"l": [false, false, false],

	"h": [false, false, false],
    "Enter": [false, false, false],
    " ": [false, false, false],
}
window.onkeydown = (e) => {
	keyboard[e.key] = [true, true, false];
}
window.onkeyup = (e) => {
	keyboard[e.key] = [false, false, true];
}

volume_slider.addEventListener("input", () => {
    song.volume = volume_slider.value / 100;
});

const BPM = 192;
const M = 60 / BPM; // this has basically no use, but it is used to get notes delays in terms of seconds instead of beats

function import_song(notes) {
    console.log(`${notes.reduce((acc, lane) => acc + lane.length, 0)} notes`);
	for (let i = 0; i < notes.length; i++) {
		for (let j = 0; j < notes[i].length; j++) {
            console.log(i);
			lanes[i].push(new Note(SPEED_MULTIPLIER * (notes[i][j] + INTRO_TIME + SONG_INTRO_TIME - START_OFFSET)));
		}
	}
}
function import_song_mora(notes) {
    const new_notes = notes.map(lane => lane.map(note => note * M));
    import_song(new_notes);
}
function import_song_chord(notes) {
    let new_notes = [[], [], [], [], []];
    let time = 0;
    for (const note of notes) {
        time += note[1];
        for (let i = 0; i < 5; i++) {
            if (note[0] >> i & 1) {
                new_notes[i].push(time);
            }
        }
    }
    import_song_mora(new_notes);
}
function mora_to_chord(lanes) {
    const pairs = [];
    for (let i = 0; i < lanes.length; i++) {
        for (const note of lanes[i]) {
            pairs.push([i, note]);
        }
    }
    pairs.sort((a, b) => a[1] - b[1]);

    const compressed = [];
    for (let i = 0; i < pairs.length;) {
        const chord = [];
        const offset = pairs[i][1];
        while (pairs[i] !== undefined && pairs[i][1] == offset) {
            chord.push(pairs[i][0]);
            i++;
        }
        const encoded = chord.sort().map((x) => Math.pow(2, x)).reduce((arr, val) => arr + val, 0);
        compressed.push([encoded, offset]);
    }

    const delta_compressed = [JSON.parse(JSON.stringify(compressed[0]))];
    for (let i = 1; i < compressed.length; i++) {
        const delta = compressed[i][1] - compressed[i - 1][1];
        delta_compressed.push([compressed[i][0], delta]);
    }

    return delta_compressed;
}

// const spam_3_2 = (lead_delta) => [
//     [4, lead_delta], [1, 0.25],
//     [8, 0.25], [2, 0.25],
//     [16, 0.25], [2, 0.25],
//     [8, 0.25], [1, 0.25],
//     [4, 0.25], [1, 0.25],
//     [8, 0.25], [2, 0.25],
//     [16, 0.25], [2, 0.25],
//     [8, 0.25], [1, 0.25],
//     [4, 0.25]
// ];
// import_song_chord([
//     [16, 0],
//     [2, 1],
//     [16, 1],
//     [4, 1],
//     [2, 0.5],
//     [8, 0.5],
//     [2, 0.5],
//     [4, 1],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [4, 1],
//     [8, 0.5],
//     [2, 0.5],
//     [16, 0.5],
//     [8, 0.5],
//     [2, 0.5],
//     [8, 0.5],
//     [4, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [16, 0.5],
//     [2, 1],
//     [16, 1],
//     [4, 1],
//     [2, 0.5],
//     [8, 0.5],
//     [2, 0.5],
//     [4, 1],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [2, 0.5],
//     [8, 0.5],
//     [2, 0.5],
//     [4, 0.5],
//     [0b00101, 0.5],
//     [0b01001, 0.5],
//     [0b00110, 1],
//     [0b01010, 1],
//     [0b00110, 1],
//     [16, 0.5],
//     [2, 1],
//     [16, 1],
//     [4, 1],
//     [2, 0.5],
//     [8, 0.5],
//     [2, 0.5],
//     [4, 1],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     [1, 1],
//     [2, 0.5],
//     [4, 0.5],
//     ...spam_3_2(4),
// ]);
import_song_mora(
[[8.25,8.75,9.252083333333333,9.752083333333333,10.25,10.75,11.252083333333333,11.752083333333333,12.25,12.75,13.252083333333333,13.752083333333333,14.25,14.75,15.252083333333333,15.752083333333333,16.25,16.75,17.25,17.75,18.25,18.75,19.252083333333335,19.752083333333335,20.25,20.75,21.252083333333335,21.752083333333335,22.25,22.75,23.252083333333335,23.752083333333335,24.25,24.75,25.25,25.75,26.25,26.75,27.25,27.75,28.25,28.75,29.25,29.75,30.25,30.75,31.25,31.75,32.25,32.75,33.25,33.75,34.25,34.75,35.25,35.75,36.25,36.75,37.25,37.75,38.25,38.75,39.25,39.75,40.25,40.75,41.25,41.75,42.25,42.75,43.25,43.75,44.25,44.75,45.25,45.75,46.25,46.75,47.25,47.75,48.25,48.75,49.25,49.75,50.25,50.75,51.25,51.75,52.25,52.75,53.25,53.75,54.25,54.75,55.25,55.75,56.25,56.75,57.25,57.75,58.25,58.75,59.25,59.75,60.25,60.75,61.25,61.75,62.25,62.75,63.25,63.75,64.25,64.75,65.25,65.75,66.25,66.75,67.25,67.75,69,71.50208333333333,73,73.25,74.5,74.75,75.5,75.75,77,77.25,78.5,78.75,79.5,79.75,81,81.25,82.5,82.75,83.5,83.75,85,85.25,86.5,86.75,87.5,87.75,89,89.25208333333333,90.5,90.75208333333333,91.50208333333333,91.75,93,93.25208333333333,94.5,94.75208333333333,95.50208333333333,95.75,97,97.25208333333333,98.50208333333333,98.75,99.5,99.75208333333333,100.25,105,105.25,106.50208333333333,106.75,107.5,107.75,109,109.25,110.5,110.75,111.5,111.75,113,113.25,114.5,114.75,115.5,115.75,117,117.25,118.5,118.75,119.5,119.75,121,121.25,122.50208333333333,122.75,123.5,123.75,125,125.25,126.50208333333333,126.75,127.5,127.75,128.5,130.5,144,176,176.50208333333333,176.75,177,177.25,177.50208333333333,177.75,178,178.25,178.50208333333333,178.75,179,179.25,179.50208333333333,179.75,180,180.25,180.5,180.75,181,181.25,181.5,181.75,182,182.25,182.5,182.75,183,183.25,183.5,183.75,199.5,200,200.25,200.5,200.75,208,208.5,208.75,209.5,209.75,210.5,210.75,211.50208333333333,211.75,212,212.5,212.75,213.5,213.75,214.5,214.75,215.5,215.75,231.5,232.50208333333333,233,234,234.5,235.5,236.50208333333333,237,238,238.5,239.5,260.25,272,276,276.25,276.5,277.5,278.5,284.50208333333336,285,286,286.50208333333336,300,304.5,305,306,306.5,307.5,308.5,308.75,328,352,356.5,357.5,358.5,359.5,360,401.5,415,415.5,419.50208333333336,419.75,421.50208333333336,425.5,426,426.5,427.25,435.50208333333336,447.50208333333336,459.5,463.5,467.50208333333336,471.50208333333336,475.50208333333336,479.5,481,482.50208333333336,483.625,496,496.50208333333336,496.75208333333336,497,497.25,497.5,497.75,498,498.25,498.50208333333336,498.75208333333336,499,499.25,499.5,499.75,500,500.25,500.50208333333336,500.75208333333336,501,501.25,501.5,501.75,502,502.25,502.50208333333336,502.75208333333336,503,503.25,503.5,503.75,520.5020833333333,521,522,522.5020833333333,523.5020833333333,524.5020833333333,525,526,526.5020833333333,527.5020833333333,535.5,549.25,549.75,551.25,551.75,560,564,564.25,564.5,565.5,566.5020833333333,572.5,573,574,574.5,588,592.5020833333333,593,594,594.5,595.5,596.5,596.75,612.1666666666666,612.5,612.8333333333334,613.1666666666666,613.5,613.8333333333334,614.2,614.6,615,615.375,615.625,615.875,616,640,644.5020833333333,646,648,678.5020833333333,689.5,699.5,707.5020833333333,713.5,714,714.5020833333333,715.25,723.5020833333333,730,731.5,735.2520833333333,750,768,775,782,812,813.5020833333333,820,821.5,828,829.5,836,837.5,850.75,865.5,867,874,874.5,875,875.5,876,877.5,884,885.5,892,893.5,900,901.5,911,912,916,917,919.3333333333334,920.1666666666666,921.875,928,935.8020833333334,942.5020833333333,950.5,953,958.5020833333333,966.5,968.75,976,977,978,979,981.75,984,989,998.5,1001.3333333333334,1007,1007.6666666666666,1010.25,1017,1018.5,1021,1026,1028,1032.25,1044,1046,1054,1054.4,1054.8,1055.5,1065,1072.25,1073,1081.5,1083,1086,1089.5,1093,1102,1112,1119,1131.5020833333333,1132,1136,1139,1147.5020833333333,1148.75,1149.75,1152.5,1164,1165.2520833333333,1167.25,1180.25,1183,1183.5,1187,1196.25,1244,1268,1292.25,1296.5,1297.3333333333333,1297.8333333333333,1298.3333333333333,1298.8333333333333,1299.3333333333333,1299.8333333333333,1309.4,1310,1313.5,1325,1325.25,1326.5,1326.75,1327.5,1327.75,1329,1329.25,1330.5020833333333,1330.7520833333333,1331.5,1331.75,1333,1333.25,1334.5,1334.75,1335.5,1335.75,1337,1337.25,1338.5,1338.75,1339.5,1339.75,1341,1341.2520833333333,1342.5,1342.75,1343.5,1343.75,1345,1345.2520833333333,1346.5,1346.75,1347.5,1347.75,1349,1349.25,1350.5020833333333,1350.75,1351.5,1351.75,1352.2520833333333,1353.2520833333333,1355.75,1357,1357.25,1358.5020833333333,1358.7520833333333,1359.5,1359.75,1361,1361.25,1362.5,1362.75,1363.5,1363.75,1365,1365.25,1366.5,1366.75,1367.5020833333333,1367.7520833333333,1369,1369.25,1370.5,1370.75,1371.5,1371.75,1373,1373.25,1374.5020833333333,1374.7520833333333,1375.5,1375.75,1377,1377.25,1378.5,1378.75,1379.5020833333333,1379.7520833333333,1383.1666666666667,1384,1395.5020833333333,1403.5020833333333,1404.1666666666667,1404.6666666666667,1405.1666666666667,1405.66875,1406.6666666666667,1407.66875,1408.6666666666667,1409.66875,1410.1666666666667,1410.6666666666667,1411.1666666666667,1431.5,1437],[8,9.5,14.502083333333333,16,17.502083333333335,22.502083333333335,24,25.5,30.502083333333335,32,33.50208333333333,38.50208333333333,40,41.50208333333333,46.50208333333333,48,49.5,54.50208333333333,56,57.5,62.5,64,65.50208333333333,68.75,69.25,71.25,71.75,100.5,101.25,128.25,128.75,129.75,130.25,130.75,131.75,144,152,160,161,162,162.5,163.5,175.5,176,184,184.50208333333333,185.5,186,186.50208333333333,186.75,187,187.25,187.5,187.75,188,188.50208333333333,189.50208333333333,190,190.5,190.75,191,191.25,191.50208333333333,191.75,199,199.5,201,201.25,202.5,202.75,205.5,205.75,209,209.25,211,211.25,213,213.25,215,215.25,216,216.50208333333333,216.75,217,217.50208333333333,218.50208333333333,220,220.50208333333333,220.75,221,221.50208333333333,230.5,231.5,232,236,240.5,242,243.5,244.5,246,247.5,248.50208333333333,249,250,250.50208333333333,251.50208333333333,252.5,253,254,254.5,255.50208333333333,260,260.75,268,271.50208333333336,272,277,280.5,281,282,282.50208333333336,287,288,288.5,288.75,289,289.25,289.5,289.75,290,290.25,290.5,290.75,291,291.25,291.50208333333336,291.75,292,292.25,292.5,292.75,293,293.25,293.5,293.75,294,294.25,294.5,294.75,295,295.25,295.50208333333336,295.75,299.5,300,308,308.25,309,309.25,311.50208333333336,311.75,320,320.25,320.50208333333336,320.75,321.50208333333336,321.75,322.50208333333336,322.75,328,336,344,344.5,344.75,345,345.25,345.5,345.75,346,346.25,346.50208333333336,346.75,347,347.25,347.5,347.75,348,348.25,348.5,348.75,349,349.25,349.5,349.75,350,350.25,350.5,350.75,351,351.25,351.5,351.75,352,356.25,356.75,357.25,357.75,358.25,358.75,359.25,359.75,360,368,376,376.5,376.75,377,377.25,377.50208333333336,377.75,378,378.25,378.50208333333336,378.75,379,379.25,379.50208333333336,379.75,380,387,387.50208333333336,389.50208333333336,393.50208333333336,393.75,396,401,402.5,407.5,415.25,415.75,419,419.25,422,424,424.5,425,427,427.50208333333336,428.5,429.5,435,437.5,446.75,448,456,456.50208333333336,457.5,459,460,460.50208333333336,461.5,463,464,464.5,465.50208333333336,467,468,468.5,469.50208333333336,471,472,472.50208333333336,473.5,475,476,476.5,477.50208333333336,479,481.25,482.75,495.5,496,504,504.5,505.5,506,506.50208333333336,506.75,507,507.25,507.5,507.75,508,508.5,509.5,510,510.5,510.75,511,511.25208333333336,511.50208333333336,511.75,518.5,520,524,528.5020833333333,530,531.5020833333333,534.75,536.5020833333333,537,538,538.5020833333333,539.5020833333333,540.5020833333333,541,542,542.5020833333333,543.5020833333333,548.75,549.5,550.75,551.5,556,559.5,560,565,568.5,569,570,570.5020833333333,575,576,576.5,576.75,577,577.25,577.5,577.75,578,578.25,578.5,578.75,579,579.2520833333333,579.5020833333333,579.75,580,580.25,580.5,580.75,581,581.25,581.5,581.75,582,582.25,582.5,582.75,583,583.2520833333333,583.5020833333333,583.75,587.5,588,596,596.25,597,597.25,599.5020833333333,599.7520833333333,608,608.2520833333333,608.5020833333333,608.75,609.5,609.75,610.5020833333333,610.75,612,614,616,624,632,632.5,632.75,633,633.25,633.5020833333333,633.7520833333333,634,634.25,634.5,634.75,635,635.25,635.5020833333333,635.7520833333333,636,636.25,636.5020833333333,636.7520833333333,637,637.25,637.5,637.75,638,638.25,638.5020833333333,638.7520833333333,639,639.25,639.5,639.75,640,644.2520833333333,644.75,645.2520833333333,645.75,646.25,646.75,647.2520833333333,647.75,648,656,664,664.5020833333333,664.7520833333333,665,665.25,665.5,665.75,666,666.25,666.5,666.75,667,667.25,667.5,667.75,668,675,675.5020833333333,678,681.5,689,690.5,695.5,699,700.6666666666666,707,709.5020833333333,712,712.5020833333333,713,715,715.5,716.5,717.5,723,728.5,729.2520833333333,729.75,730.2520833333333,730.75,731.25,731.75,734.6270833333333,736,743,748,751.5020833333333,759,764,767,768,775,780,783,791.5,796,802,812.25,812.5020833333333,812.7520833333333,813,813.25,813.75,814.25,814.5020833333333,814.75,815,815.25,815.5020833333333,815.75,819.5020833333333,819.75,820.25,820.5020833333333,820.75,821,821.2520833333333,821.7520833333333,822.25,822.5020833333333,822.75,823,823.2520833333333,823.5,823.7520833333333,827.5020833333333,827.75,828.25,828.5020833333333,828.75,829,829.2520833333333,829.7520833333333,830.25,830.5020833333333,830.75,831,831.25,831.5020833333333,831.75,835.5020833333333,835.75,836.25,836.5020833333333,836.75,837,837.2520833333333,837.7520833333333,838.25,838.5020833333333,838.75,839,839.25,839.5020833333333,839.75,843.5020833333333,843.75,847,850.5020833333333,851,852,852.5020833333333,855,855.5020833333333,857,857.25,858.75,863.5020833333333,864.7520833333333,866,866.5,868.75,869.75,870.75,871.75,872.25,873.75,876.25,876.5020833333333,876.75,877,877.2520833333333,877.7520833333333,878.25,878.5020833333333,878.75,879,879.2520833333333,879.5,879.7520833333333,883.5020833333333,883.75,884.25,884.5020833333333,884.75,885,885.2520833333333,885.7520833333333,886.25,886.5020833333333,886.75,887,887.25,887.5020833333333,887.75,891.5020833333333,891.75,892.25,892.5020833333333,892.75,893,893.2520833333333,893.7520833333333,894.25,894.5020833333333,894.75,895,895.25,895.5020833333333,895.75,899.5020833333333,899.75,900.25,900.5020833333333,900.75,901,901.2520833333333,901.7520833333333,902.25,902.5020833333333,902.75,903,903.25,903.5020833333333,903.75,907.5020833333333,907.75,910.5020833333333,912.6666666666666,916.2,917.25,919,919.5833333333334,920,920.3333333333334,921,921.6875,922,925.9979166666667,927.5,928.25,933.375,934.0833333333334,934.75,935.2020833333333,935.6,936,936.625,937.1666666666666,937.5,942,943,946,950,951,952.75,953.25,954.75,958,959,962,966,967,968.5020833333333,969,976.1666666666666,977.1666666666666,978.1666666666666,979.1666666666666,981.4375,982,983,984.25,984.75,988.5,988.75,989.2854166666667,991.1875,993.3583333333333,997.5,998.2854166666667,998.75,1000.75,1002.2083333333334,1004,1006.8,1007.3333333333334,1009.75,1010.5,1013,1014.5,1016,1017.5,1023,1025.5,1028.5,1030.25,1031.75,1032.625,1034.25,1037.5,1039.5,1041.5,1044.25,1045,1046.25,1046.75,1047.4979166666667,1051,1054.2,1054.6,1055,1055.3333333333333,1059,1060.125,1060.375,1060.625,1060.875,1061.125,1061.375,1061.625,1061.875,1062.125,1062.375,1062.625,1062.875,1063.125,1063.375,1063.625,1063.875,1064.75,1065.25,1068,1068.5,1069,1069.5020833333333,1071,1072,1072.5,1073.25,1081,1085.5020833333333,1086.5,1088,1093.1666666666667,1099.25,1101.5,1103.5,1104.5,1105.5,1107,1111.5,1112.5,1118,1119.5,1125.125,1126.8333333333333,1127.1666666666667,1131,1132.25,1134.0625,1134.8125,1135.7083333333333,1136.25,1137,1138.6666666666667,1139.25,1142.7520833333333,1143.5020833333333,1146.5,1149,1149.5,1150,1150.5,1151,1151.5020833333333,1152,1153.5,1163,1164.25,1165.5020833333333,1166.25,1167.5,1169.5,1170,1171,1172.5,1172.75,1173.5020833333333,1173.7520833333333,1174.5,1174.75,1175.5020833333333,1175.7520833333333,1176.3333333333333,1176.8333333333333,1177.3333333333333,1177.8333333333333,1178.3333333333333,1178.8333333333333,1179.3333333333333,1179.8333333333333,1180.5,1181.8333333333333,1182.25,1182.75,1183.25,1183.75,1185.75,1186.75,1191.5020833333333,1195,1196,1196.5,1200.2520833333333,1200.75,1201.25,1201.75,1202.25,1202.75,1203.25,1203.75,1220,1236,1244,1252,1260.5,1260.75,1261.5020833333333,1261.75,1262.5,1262.75,1264.5,1268,1276,1284,1284.5,1284.75,1285,1285.25,1285.5,1285.75,1286,1286.25,1286.5020833333333,1286.7520833333333,1287,1287.25,1287.5,1287.75,1288,1288.25,1288.5,1288.75,1289,1289.25,1289.5,1289.75,1290,1290.25,1290.5,1290.75,1291,1291.25,1291.5,1291.75,1292.5,1293.25,1294.25,1296.25,1296.75,1297.1666666666667,1297.6666666666667,1298.1666666666667,1298.6666666666667,1299.1666666666667,1299.6666666666667,1307,1308.8333333333333,1309.2,1309.8,1310.25,1311,1313,1313.75,1320,1352.5020833333333,1353.5020833333333,1355.5020833333333,1380,1381.75,1382.5020833333333,1383,1383.3333333333333,1383.75,1384.25,1384.75,1395,1396,1397.5020833333333,1399,1400.5,1401,1403,1404,1404.5,1405,1405.5,1406.5,1407.5,1408.5,1409.5,1410,1410.5,1411,1429.5,1431,1434,1436.75,1437.25,1438],[8.502083333333333,10,11.5,13.5,15.5,16.502083333333335,18,19.5,21.5,23.5,24.5,26,27.5,29.5,31.5,32.50208333333333,34,35.50208333333333,37.5,39.50208333333333,40.5,42,43.5,45.5,47.50208333333333,48.50208333333333,50,51.5,53.5,55.5,56.5,58,59.5,61.5,63.5,64.5,66,67.50208333333333,68.5,69.50208333333333,70,71,72,72.25,72.50208333333333,72.75,73.5,73.75,74,74.25,75,75.25,76,76.25,76.50208333333333,76.75,77.5,77.75,78,78.25,79,79.25,96,96.25,96.50208333333333,96.75,97.5,97.75208333333333,98,98.25,99,99.25208333333333,100,100.75,101.5,103,104,104.25,104.5,104.75,105.5,105.75,106,106.25,107,107.25,108,108.25,108.5,108.75,109.5,109.75,110,110.25,111,111.25,128,129,129.5,130,131,131.50208333333333,136,144,152,160,161,162,162.5,163.5,164,168,168.25,168.5,168.75,169.5,169.75,170.5,170.75,171.5,171.75,172,172.25,172.50208333333333,172.75,173.50208333333333,173.75,174,174.5,175.5,176,184.50208333333333,185.5,186,188.50208333333333,189.50208333333333,190,192,192.5,193,193.25,193.5,193.75,194,194.50208333333333,195,195.25,195.5,195.75,196,197.5,198.5,199,201.5,201.75,203,203.25,205,205.25,206,206.25,210,210.25,214,214.25,222.50208333333333,224,224.5,224.75,225,225.25,225.5,225.75,226,226.25,226.5,226.75,227,227.25,227.5,227.75,228,228.5,229.5,230.5,235,239,240.25,240.75,241.25,241.75,242.25,242.75,243.25,243.75,244.25,244.75,245.25,245.75,246.25,246.75,247.25,247.75,251,255,256.5,258,259.5,260.5,261.25,264,268,271,271.50208333333336,272,278,283,284,285.5,287.50208333333336,288,296,299,299.5,300,304,305.5,307,309.5,309.75,311,311.25,312,312.25,312.50208333333336,312.75,313.5,313.75,314.5,314.75,316,316.25,316.50208333333336,316.75,317.5,317.75,318.5,318.75,321,321.25,323,323.25,324,336,344,352,356,368,376,380,385.50208333333336,386.50208333333336,387.25,390,394,394.25,395.5,395.75,396.5,400.5,403,407.25,409,410.5,411.5,412.25,412.75,413.25,413.75,414.25,414.75,417.5,418.50208333333336,418.75,422.1666666666667,422.50208333333336,425.75,426.25,426.75,429.75,433.75,434.5,437.75,441.3333333333333,442.6666666666667,444,444.5,444.75,446,457,458.5,461,462.5,465,466.5,469,470.5,473,474.50208333333336,477,478.50208333333336,480,480.5,480.8333333333333,481.5,482,482.3333333333333,483,483.4375,488,488.25208333333336,488.50208333333336,488.75,489.5,489.75,490.50208333333336,490.75,491.5,491.75,492,492.25208333333336,492.50208333333336,492.75,493.50208333333336,493.75,494,494.5,495.5,496,504.5,505.5,506,508.5,509.5,510,512,512.5,513,513.25,513.5,513.75,514,514.5,515,515.25,515.5,515.75,516,517.5,523,527,528.2520833333333,528.75,529.2520833333333,529.75,530.25,530.75,531.2520833333333,531.75,532.25,534,539,543,544.5,545.9979166666667,547.5,548.25,549,550.25,551,552,556,559,559.5,560,566,571,572,573.5,575.5020833333333,576,584,587,587.5,588,592,593.5,595,597.5,597.75,599,599.25,600,600.25,600.5,600.75,601.5,601.75,602.5,602.75,604,604.25,604.5,604.75,605.5,605.75,606.5020833333333,606.7520833333333,609,609.25,611,611.2520833333333,612.3333333333334,612.6666666666666,614.4,615.25,624,632,640,645,645.5020833333333,656,664,668,673.5020833333333,674.5,675.2520833333333,677.5,679,680,680.5,682,683.5,685,688.5,691,692.5,695.25,697,698.5,700,701.3333333333334,702,705.5,706.5020833333333,708.5,709,710,713.75,714.25,714.7520833333333,717.75,721.75,722.5,725.5,726,728.75,729.5020833333333,731,733,734,743,744,746,751.5020833333333,752,758,759,760,762,765.5020833333333,768,775,776,778,783,784,790,791.5,792,794,797.5,800,802,814,817.5020833333333,817.75,818.7520833333333,819,819.25,822,825.5020833333333,825.75,826.7520833333333,827,827.25,830,833.5020833333333,833.75,834.75,835,835.25,838,841.5020833333333,841.75,842.75,843,843.25,846.5020833333333,848,848.5020833333333,850.25,853,853.5020833333333,854,854.5020833333333,855.25,855.75,856.5020833333333,856.75,857.5020833333333,857.75,858,858.25,858.5,859,861.75,862.75,864,866.2520833333333,866.7520833333333,868,868.25,868.5,869,869.5,870,870.25,870.5020833333333,871,871.5,872,872.5,873.5020833333333,878,881.5020833333333,881.75,882.75,883,883.25,886,889.5020833333333,889.75,890.75,891,891.25,894,897.5020833333333,897.75,898.75,899,899.25,902,905.5,905.75,906.75,907,907.25,908,908.25,908.5020833333333,908.75,909.5020833333333,911.5,913.3333333333334,916.4,916.8125,917.5,917.8125,918.375,918.75,919.75,920.5,921.1875,921.5,922.25,923.9979166666667,925.5,928.5020833333333,930.5020833333333,932.25,932.875,933.8333333333334,934.5,935.4,936.1666666666666,936.8125,937.8333333333334,938.25,939,939.5,941.5,943.5,945.5020833333333,949.5020833333333,951.5020833333333,952,952.5020833333333,953.5,954.5020833333333,955,957.5,959.5,961.5,965.5020833333333,967.5020833333333,968.25,969.25,972,973,973.8333333333334,976.3354166666667,977.3354166666667,978.3354166666667,979.3354166666667,980.5,981.125,982.25,983.25,984.5,985,986,988.25,989.5708333333333,991.75,993.0729166666666,997,998.14375,999,1000.25,1001.9583333333334,1002.4375,1003,1004.3333333333334,1005,1006,1006.5333333333333,1008.5,1009.5,1010.75,1011.25,1015.5,1018,1022.5,1027,1028.7,1029.1,1030,1031,1031.5,1032,1032.9375,1034,1034.5,1039,1039.3333333333333,1039.75,1044.5,1045.25,1046.5,1047,1047.7479166666667,1050.5020833333333,1053.3333333333333,1053.8333333333333,1055.1666666666667,1057.5,1058.5,1059.5,1060.5,1060.75,1062.5,1062.75,1064.5,1065.5020833333333,1066,1066.5,1067.5,1068.25,1068.75,1070,1072.75,1073.5020833333333,1079.75,1080.5020833333333,1083.5,1085,1087,1088.5,1094,1095.375,1098.5,1101,1102.5,1105,1109.5,1111,1113,1114.66875,1117,1118.5,1124.6666666666667,1125.2916666666667,1125.6666666666667,1126.25,1126.6666666666667,1127,1127.3333333333333,1127.6666666666667,1128.1666666666667,1128.6666666666667,1129.6666666666667,1130.0833333333333,1130.75,1132.5,1133,1133.8125,1134.5625,1135.4166666666667,1136.5,1137.25,1138.3333333333333,1139.5,1144,1148.5,1149.25,1153,1157,1158.5020833333333,1159.5,1162.5,1164.5,1165.75,1166.5,1167.75,1168.2520833333333,1169.3333333333333,1169.8333333333333,1170.25,1170.75,1172,1172.25,1176.1666666666667,1176.6666666666667,1177.1666666666667,1177.6666666666667,1178.1666666666667,1178.6666666666667,1179.1666666666667,1179.6666666666667,1180,1180.75,1181.6666666666667,1182.5,1184.75,1185.5,1186,1186.5,1190.5,1191,1194.5,1196.75,1197.25,1198.25,1198.75,1201.5,1202,1203.5,1220,1228,1236,1252,1264.25,1266.5,1276,1284,1292,1292.75,1293.5020833333333,1294.5,1295.25,1297,1298.5,1308.6666666666667,1309,1309.6,1310.5,1311.25,1312.5,1313.25,1314,1320,1324,1324.25,1324.5,1324.75,1325.5,1325.75,1326,1326.25,1327,1327.25,1328,1328.25,1328.5,1328.75,1329.5,1329.75,1330,1330.25,1331,1331.25,1348,1348.2520833333333,1348.5020833333333,1348.75,1349.5,1349.75,1350,1350.2520833333333,1351,1351.25,1352,1352.75,1353.75,1354.75,1355.2520833333333,1356,1356.25,1356.5,1356.75,1357.5,1357.75,1358,1358.25,1359,1359.25,1360,1360.25,1360.5,1360.75,1361.5,1361.75,1362,1362.25,1363,1363.25,1380.25,1380.75,1381.5,1382.25,1382.7520833333333,1383.5,1384.5,1385,1385.6,1386.2,1386.75,1387.25,1387.7520833333333,1396.5,1397,1398,1398.5,1399.5020833333333,1400,1401.5020833333333,1402.5,1412,1412.75,1413.375,1414,1414.5,1415,1415.6666666666667,1416.03125,1416.4583333333333,1417.1666666666667,1417.6666666666667,1418.125,1418.6666666666667,1419.1666666666667,1419.7083333333333,1420.28125,1421,1421.5,1422.0208333333333,1422.375,1422.8333333333333,1423.25,1423.5625,1424.0625,1424.5,1424.875,1425.3333333333333,1425.8333333333333,1426.25,1426.625,1427,1427.5,1427.8333333333333,1429,1430.5,1434,1436.5,1437.5,1438.6666666666667],[9,10.502083333333333,12.502083333333333,14,15,17,18.502083333333335,20.502083333333335,22,23,25,26.502083333333335,28.5,30,31,33,34.50208333333333,36.50208333333333,38,39,41,42.50208333333333,44.50208333333333,46,47,49,50.50208333333333,52.50208333333333,54,55,57,58.5,60.50208333333333,62,63,65,66.5,68.25,69.75,70.25,70.75,88,88.25208333333333,88.5,88.75208333333333,89.5,89.75208333333333,90,90.25208333333333,91,91.25,92,92.25208333333333,92.5,92.75208333333333,93.5,93.75208333333333,94,94.25208333333333,95,95.25,101,101.75,102.5,120,120.25,120.50208333333333,120.75,121.5,121.75,122,122.25,123,123.25,124,124.25,124.50208333333333,124.75,125.5,125.75,126,126.25,127,127.25,129.25,131.25,132,136,152,160,161,162,162.5,163.5,164,170,170.25,174,174.5,175.5,184,184.50208333333333,186,188,188.50208333333333,190,192,192.5,193,193.25,193.5,193.75,194,194.50208333333333,195,195.25,195.5,195.75,196,196.5,197.5,198,198.5,202,202.25,203.5,203.75,204.5,204.75,206.5,207,218,219,222,223,224,228.5,229.5,233.5,237.5,240,241,241.5,242.5,243,244,245,245.50208333333333,246.5,247,249.5,253.50208333333333,256.25,256.75,257.25,257.75,258.25,258.75,259.25,259.75,261,261.75,264,268,271,280,281.50208333333336,283.5,288,296,299,310.50208333333336,310.75,313,313.25,315,315.25,317,317.25,319,319.25,322,322.25,323.50208333333336,323.75,325.50208333333336,328,344,357,359,360,376,380,384,384.50208333333336,386,388,388.50208333333336,390.50208333333336,392,392.5,394.5,394.75,397,400,403.50208333333336,404.5,405.5,407,412,412.5,413,413.5,414,414.5,416,416.5,418,418.25,420,420.50208333333336,422.66875,423,428,429,432,432.5,433.50208333333336,434,436,436.50208333333336,438,440.25,440.75,441.1666666666667,441.6666666666667,442.0833333333333,442.5,443,443.4166666666667,443.8333333333333,445,458,462,466,470,474,478,486,490,490.25,494,494.5,495.5,504,504.5,506,508,508.5,510,512,512.5,513,513.25,513.5,513.75,514,514.5,515,515.25,515.5,515.75,516,516.5,517.5,518,521.5020833333333,525.5020833333333,528,529,529.5020833333333,530.5,531,532,533.25,537.5020833333333,541.5020833333333,544.2479166666667,544.75,545.2479166666667,545.75,546.25,546.75,547.2479166666667,547.75,548.5,550.5,552,556,559,568,569.5,571.5,576,584,587,598.5,598.75,601,601.25,603,603.25,605,605.25,607,607.25,610,610.2520833333333,611.5,611.75,613,613.3333333333334,614.8,615.5,616,632,644,646.5,647.5020833333333,648,663,664,668,672,672.5,674,676,676.5020833333333,679.25,682.5,684.5,685.5,688,691.5020833333333,693,695,696,696.5,697.5,704.5020833333333,705,706,710.5,716,717,720,720.5,721.5,722,724,724.5,725.75,728.25,729,730.5020833333333,732,732.25,732.5020833333333,732.75,733.1666666666666,743,744,751.5020833333333,752,756,759,760,776,783,784,788,791.5,792,799,800,804.1895833333333,804.6875,805.1875,805.6875,806.1895833333333,806.6875,807.1895833333333,807.6875,808.1875,808.6875,809.1895833333333,809.6875,810.1875,810.6875,811.1895833333333,811.6875,816.75,817,817.25,818,818.2520833333333,818.5,824.75,825,825.25,826,826.2520833333333,826.5,832.75,833,833.25,834,834.25,834.5020833333333,840.75,841,841.25,842,842.25,842.5020833333333,844,844.5020833333333,846,849.5020833333333,850,852.25,852.75,854.25,854.75,856,856.25,859.25,860,860.5020833333333,861.5020833333333,862,869.25,871.25,872.75,873.25,880.75,881,881.25,882,882.25,882.5020833333333,888.75,889,889.25,890,890.25,890.5020833333333,896.75,897,897.25,898,898.25,898.5,904.75,905,905.25,906,906.25,906.5020833333333,910,914,916.625,917.625,918.25,918.5,920.6666666666666,921.3333333333334,922.5,923,924.7479166666667,928.75,930.25,930.75,932,932.375,932.75,933.1666666666666,934.3333333333334,935,936.3333333333334,937,937.3333333333334,937.6666666666666,938.5,938.875,939.25,939.75,940,940.5,940.75,941,944,944.5,944.7520833333333,945,947,948,948.5020833333333,948.75,949,952.25,953.75,954.25,956,956.5020833333333,956.75,957,960,960.5020833333333,960.75,961,963,964,964.5020833333333,964.75,965,968,969.5,972.1666666666666,972.5,972.8333333333334,973.3333333333334,973.6666666666666,976.5020833333333,977.5020833333333,978.5020833333333,979.5020833333333,980.25,980.8333333333334,982.5,983.5,985.3333333333334,986.25,986.75,988,989.85625,990.375,990.875,991.5,992.25,992.7854166666667,993.8333333333334,995.5,996.25,998,999.125,999.5,999.75,1000,1000.5020833333333,1001,1001.6666666666666,1002.6666666666666,1003.25,1004.6666666666666,1005.3333333333334,1005.75,1006.2666666666667,1008.25,1008.75,1009.25,1011,1011.5,1012,1015,1016.5,1019,1022,1026.5,1028.9,1029.3,1029.75,1030.75,1033.25,1033.75,1034.75,1036.25,1036.75,1037.25,1037.8333333333333,1038.25,1038.6666666666667,1038.66875,1039.1666666666667,1040,1040.4,1040.8333333333333,1041.25,1041.875,1044.75,1045.5,1047.25,1047.9979166666667,1048.5,1049.5,1050,1052,1052.4,1052.8,1053.1666666666667,1053.6666666666667,1057,1058,1060,1060.25,1061,1061.25,1062,1062.25,1063,1063.25,1064.25,1065.75,1066.25,1066.75,1067.1666666666667,1069.25,1069.75,1073.75,1076,1077.5020833333333,1079.5,1080,1083.75,1084.5,1087.5,1089,1095,1095.8333333333333,1097,1097.5,1100.5,1103,1108,1109,1110.5020833333333,1113.5,1114.3354166666666,1116,1117.5,1120,1120.5,1121,1124.3333333333333,1124.875,1125.8333333333333,1126.5,1127.8333333333333,1128.3333333333333,1128.8333333333333,1129.25,1129.875,1130.5,1132.75,1133.1666666666667,1133.5625,1134.3125,1135.125,1136.75,1137.5020833333333,1138,1139.75,1144.5020833333333,1145.5,1148.25,1156,1156.5,1157.5,1159,1160,1160.5,1161.5020833333333,1164.75,1166,1166.75,1168,1168.75,1169.1666666666667,1169.6666666666667,1170.5,1171.25,1171.75,1173,1173.25,1175,1175.25,1178,1178.5,1179,1179.5,1181,1181.5,1182,1184.5,1185,1185.25,1186.25,1188.5,1189.5,1193.5,1194,1197,1197.5,1198,1198.5,1199.25,1199.75,1200.5,1201,1202.5,1203,1220,1228,1244,1252,1264,1266.25,1268,1284,1293,1293.7520833333333,1294.75,1295.5,1296,1297.5,1299,1303.5,1305.5,1308,1308.5,1310.75,1311.5,1312,1312.75,1315,1319,1320,1340,1340.25,1340.5,1340.75,1341.5020833333333,1341.75,1342,1342.25,1343,1343.25,1344,1344.25,1344.5,1344.75,1345.5020833333333,1345.75,1346,1346.25,1347,1347.25,1353,1354,1354.5,1355,1372,1372.25,1372.5020833333333,1372.7520833333333,1373.5,1373.75,1374,1374.25,1375,1375.25,1376,1376.25,1376.5,1376.75,1377.5020833333333,1377.7520833333333,1378,1378.25,1379,1379.25,1380.5,1381,1381.3333333333333,1382,1385.2,1385.8,1386.375,1386.625,1387.0833333333333,1387.5020833333333,1388,1389.5020833333333,1391,1392.5020833333333,1393,1394.5,1402,1412.9375,1413.8125,1415.1666666666667,1415.5,1416.1875,1416.625,1417,1417.3333333333333,1417.8333333333333,1418.25,1418.5,1418.8333333333333,1419.375,1419.8583333333333,1420.15625,1420.4375,1420.8125,1421.375,1421.875,1422.2708333333333,1422.4791666666667,1422.7083333333333,1423.125,1423.9166666666667,1424.375,1424.75,1425.1875,1425.6666666666667,1426.125,1426.5,1426.875,1427.125,1427.375,1427.6666666666667,1428.5,1430,1432,1436.25,1437.75,1439.3354166666666],[11,12,13,19,20,21,27,28,29,35,36,37,43,44,45,51,52,53,59,60,61,67,68,70.5,80,80.25,80.5,80.75,81.50208333333333,81.75,82,82.25,83,83.25,84,84.25,84.50208333333333,84.75,85.5,85.75,86,86.25,87,87.25,102,112,112.25,112.5,112.75,113.50208333333333,113.75,114,114.25,115,115.25,116,116.25,116.50208333333333,116.75,117.5,117.75,118,118.25,119,119.25,132.25,136,164,169,169.25,171,171.25,173,173.25,174.5,196.5,198,204,204.25,219.50208333333333,223.50208333333333,224,228.5,229.5,248,252,256,257,257.5,258.50208333333336,259,261.5,262,264,279,296,310,310.25,314,314.25,315.5,315.75,318,318.25,319.5,319.75,327,336,358,368,391,395,395.25,397.50208333333336,404,405,405.6666666666667,406.5,408,408.50208333333336,409.5,410,411,423.1666666666667,424.25,424.75,425.25,438.50208333333336,439,440,440.5,441,441.5,441.8333333333333,442.25,443.25,443.6666666666667,480.25,480.6666666666667,481.75,482.1666666666667,483.25,484,489,489.25,491,491.25,493,493.25,494.5,516.5,518,519,532.5,536,540,544,545,545.5020833333333,546.5,547,548,550,552,567,584,598,598.25,602,602.25,603.5,603.75,606,606.25,607.5,607.75,613.6666666666666,615.75,624,647,656,663,683,684,692,693.5,694.5,711,712.25,712.7520833333333,713.25,726.5,727,728,744,752,754,760,776,784,786,792,804,804.5020833333333,805,805.5,806,806.5020833333333,807,807.5020833333333,808,808.5,809,809.5020833333333,810,810.5,811,811.5020833333333,816,816.25,816.5020833333333,824,824.25,824.5020833333333,832,832.25,832.5020833333333,840,840.25,840.5020833333333,845.5020833333333,849.6666666666666,853.25,853.75,859.5020833333333,873,880,880.25,880.5020833333333,888,888.25,888.5,896,896.25,896.5020833333333,904,904.25,904.5020833333333,909,918,920.8333333333334,922.75,926.75,929,930,932.5,933.625,938.0833333333334,938.625,946.5020833333333,954,962.5020833333333,969.75,972.3333333333334,972.6666666666666,973.1666666666666,973.5,980,982.75,983.75,985.6666666666666,986.5,987,990.125,990.625,992,992.5,994,996,996.5020833333333,996.75,997.25,997.75,1003.5,1005.5,1008,1009,1011.75,1013.5,1020,1020.5020833333333,1021.5,1024,1024.5,1025,1029.5,1030.5,1031.25,1033.5,1035,1036,1036.5,1037,1038,1038.5020833333333,1040.2,1040.625,1041,1043,1045.75,1049.6666666666667,1052.2,1052.6,1053,1053.5,1056,1056.25,1056.5020833333333,1056.75,1061.5,1061.75,1063.5,1063.75,1064,1067,1074,1076.25,1077.75,1084,1090,1096,1100,1106,1108.5,1114,1115,1116.5,1121.5,1122,1122.5,1123,1124,1125.5,1126,1127.5,1128,1128.5,1129,1129.5,1130.2916666666667,1133.3333333333333,1137.7520833333333,1140,1141.5020833333333,1142.5020833333333,1145.75,1148,1160.6666666666667,1165,1167,1168.5,1169,1171.5,1174,1174.25,1176,1176.5,1177,1177.5,1181.25,1184,1184.25,1188,1189,1189.75,1192,1192.5,1193.75,1197.75,1199,1199.5,1200,1204,1228,1236,1260,1260.25,1261,1261.2520833333333,1262,1262.25,1263,1263.25,1263.5,1263.75,1266,1276,1294,1295,1295.75,1298,1299.5,1300,1303,1304,1308.25,1311.75,1312.25,1316,1317.5,1332,1332.25,1332.5,1332.75,1333.5,1333.75,1334,1334.25,1335,1335.25,1336,1336.25,1336.5,1336.75,1337.5020833333333,1337.7520833333333,1338,1338.25,1339,1339.25,1354.25,1364,1364.25,1364.5020833333333,1364.7520833333333,1365.5,1365.75,1366,1366.25,1367,1367.25,1368,1368.25,1368.5,1368.75,1369.5020833333333,1369.7520833333333,1370,1370.25,1371,1371.25,1381.1666666666667,1385.4,1386,1386.5,1386.9166666666667,1388.5020833333333,1389,1390,1390.5020833333333,1391.5020833333333,1392,1393.5020833333333,1394,1412.3333333333333,1413.125,1413.625,1414.25,1414.75,1415.3333333333333,1415.875,1416.3333333333333,1416.7916666666667,1417.5,1418,1418.375,1419,1419.5833333333333,1420,1420.625,1421.25,1421.75,1422.1666666666667,1422.5833333333333,1423,1423.375,1423.75,1424.25,1424.625,1425,1425.5,1426,1426.375,1426.75,1427.25,1428,1432.2520833333333,1436,1440]]
);

function draw_note(x, y, color, is_peg=false) {
	if (is_peg) {
		ctx.fillStyle = color;
		ctx.fillRect(x, y - 5, LANE_WIDTH, 10);
	} else {
		ctx.fillStyle = color;
		ctx.fillRect(x, y - TILE_HEIGHT / 2, LANE_WIDTH, TILE_HEIGHT);
	}
}

function lane_activation(i, col) {
	return (i == 0 && keyboard["d"][col])
		|| (i == 1 && keyboard["f"][col])
		|| (i == 2 && keyboard["j"][col])
		|| (i == 3 && keyboard["k"][col])
		|| (i == 4 && keyboard["l"][col]);
}

function draw(lanes) {
    ctx.fillStyle = "#f8f8f240";
    ctx.font = "400px sans";
    ctx.fillText(combo, (canvas.width - ctx.measureText(combo).width) / 2, 600);
	for (let i = 0; i < lanes.length; i++) {
        const notes = lanes[i];
		const note_color = [
			"#50fa7b",
			"#ff5555",
			"#f1fa8c",
			"#6272a4",
			"#ffb86c",
		][i];
        const x = LANE_LEFT + (LANE_WIDTH + LANE_PADDING) * i;
		const lane_y = get_y_coord(0.0);
        const lane_activated = lane_activation(i, 1);
        let missed_note = false;
        let hit_note = false;
		for (let j = notes.length - 1; j >= 0; j--) {
			const note = notes[j];
			if (note.countdown < MIN_NOTE_DISPLAY) {
                missed_note |= true;
                console.debug("Went offscreen", i);
				notes.shift();
				j--;
				continue;
			}
			if (note.countdown > MAX_NOTE_DISPLAY) {
				continue;
			}
			if (lane_activated) {
                if (Math.abs(note.countdown) < GRACE_PERIOD) {
                    hit_note = true;
                    missed_note = false;
                    console.debug("Hit", i);
                    notes.shift();
                    j--;
                    continue;
                } else if (!hit_note) {
                    missed_note |= true;
                    console.debug("Extra note", i);
                }
			}
            const y = get_y_coord(notes[j].countdown);
			draw_note(x, y, note_color);
        }
        if (hit_note) {
            combo++;
        }
        if (missed_note) {
            combo = 0;
        }
		const lane_color = lane_activation(i, 0) ? "#8be9fd" : "#f8f8f2";
		draw_note(x, lane_y, lane_color, true);
    }
}

let current_state = state.Menu;

const song = new Audio("magical_cure.mp3");
song.currentTime = START_OFFSET;
song.playbackRate = SPEED_HACK;
song.volume = volume_slider.value / 100;
let last_frame_time = -1;
function menu_tick() {
    const button_width = canvas.width * 0.15;
    const button_height = canvas.height * 0.1;
    const button_x = (canvas.width - button_width) / 2;
    const button_y = (canvas.height - button_height) / 2;

    ctx.fillStyle = "#282a36";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#44475a";
    ctx.strokeStyle = "#f8f8f2";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.roundRect(button_x, button_y, button_width, button_height, [20, 20]);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    if (keyboard[" "][1]) {
        current_state = state.Playing;
        setTimeout(() => {
            song.play();
        }, (INTRO_TIME - START_OFFSET) * 1000 / SPEED_HACK);
    }
}
function playing_tick() {
    if (keyboard["h"][1]) {
		game_running = !game_running;
        if (game_running) {
            song.play();
        } else {
            song.pause();
        }
	}
	ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#282a36"
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const current_frame_time = new Date().getTime() / 1000;
    let delta_time = current_frame_time - last_frame_time;
    if (last_frame_time < 0) {
        delta_time = 0;
    }
    last_frame_time = current_frame_time;
    for (let notes of lanes) {
        for (let note of notes) {
            note.update(game_running ? delta_time : 0);
        }
    }
    draw(lanes);
	for (const key in keyboard) {
		keyboard[key][1] = false;
		keyboard[key][2] = false;
	}
}
function tick() {
    switch (current_state) {
        case state.Menu:
            menu_tick();
            break;
        case state.Playing:
            playing_tick();
            break;
        case state.Paused:
            console.error("state.Paused is not implemented yet");
            break;
    }
    window.requestAnimationFrame(tick);
}

tick();
